{% extends "base.html" %}
{% block content %}
<section id="fh5co-work" data-section="work" class="animated">
		<div class="container">
			<div class="row row-bottom-padded-sm loader_div">
					
					<article class="buffer loading">
						<svg width="100%" height="100%" x="0px" y="0px" viewBox="0 0 313.3 321.4" style="enable-background:new 0 0 313.3 321.4;" xml:space="preserve">
						<path class="layer layer1" d="M157.1,0c3.8,0,7.9,1.5,11.4,3.2c45.6,21.1,91.2,42.4,136.7,63.8c3.3,1.5,8,2.1,8.1,7c0.1,5-4.7,5.6-7.9,7.1
						  c-45.8,21.5-91.7,42.9-137.6,64.3c-7.4,3.4-14.8,3.5-22.2,0C99,123.6,52.3,101.9,5.8,80c-2.4-1.1-5.4-4-5.4-6c0-2,3.1-4.8,5.5-5.9
						  C52.4,46.2,99.1,24.4,145.8,2.8C149.1,1.2,154.5,0,157.1,0z"/>
						<path class="layer layer2" d="M156.6,235c-3.1,0-7.7-1.7-11.3-3.3c-46.5-21.6-93-43.3-139.4-65.1c-2.4-1.1-5.8-4.1-5.6-5.8c0.3-2.4,3.2-5,5.7-6.3
						  c7.5-4,15.3-7.3,23-10.9c7.9-3.7,15.7-3.6,23.6,0.1c30.4,14.3,61,28.4,91.4,42.7c8.6,4.1,16.8,4,25.4-0.1
						  c30.4-14.3,60.9-28.4,91.4-42.7c7.7-3.6,15.4-3.7,23.1-0.1c8.2,3.8,16.4,7.4,24.4,11.5c2.1,1.1,4.9,3.7,4.7,5.4
						  c-0.2,2.1-2.7,4.8-4.9,5.9c-46.8,22.1-93.7,44-140.7,65.8C164.2,233.5,159.9,235,156.6,235z"/>
						<path class="layer layer3" d="M156.8,321.4c-4.6,0-9.3-2.3-13.4-4.2c-45.2-20.9-90.3-42-135.4-63.1c-3.3-1.5-8-2.1-8-7.1c0-5,3.8-5.5,7-7.1
						  c13.9-6.5,14.9-6.5,21.8-9.8c8-3.8,16-3.7,24.1,0.1c29.9,14,59.8,27.7,89.6,41.9c9.6,4.6,18.5,4.7,28.2,0.1
						  c29.8-14.2,59.8-27.9,89.6-41.9c8.2-3.9,16.3-4,24.5,0c7.8,3.8,15.8,7.2,23.5,11.1c2.1,1.1,4.8,3.3,4.8,5.4
						  c-0.1,2.4-2.7,4.8-4.9,5.9c-32.2,15.3-64.5,30.3-96.8,45.4c-13.9,6.5-27.7,13.1-41.7,19.3C165.7,319.2,161.5,321.4,156.8,321.4z"/>
						</svg>
					</article>
					<div class="row understand_data">Understanding your data... </div>
						
				</div>
				<div class="panel-group init_hidden" style="display: none;" id="accordion">
					<div class="toggler">
						<a role="button" data-toggle="collapse" data-parent="#accordion" href="#form_section" aria-expanded="false" aria-controls="form_section">
							 Search
						</a>
					</div>
					<div id="form_section" class="collapse">

						<div class="row">
							<div class="col-md-12 section-heading text-center question_container">
								<h3 class="to-animate fadeInUp animated">Select a Question: </h3>
								<div class="row">
									<form id="questions_form" action="{{ url_for('question_page') }}" method=POST class=questions>
									<div class="form-group">
										
										<select name="question">
											<option>For last month return max of balance For every customer where branch = Mountain-View</option>
											<option>For last month return sum of amount For every branch where transaction_type = Deposit</option>
											{% for question in question_list %}
											    <option>{{question}}</option>
											{% endfor %}
										</select>
									    
										<br>
										</div>
										<div class="form-group ">
										<input class="btn btn-primary btn-lg disabled" type=submit name=Submit>
										</div>
									</form>
								</div>
							</div>
						</div>
						<div class="row row-bottom-padded-sm">
							<div class="col-xs-offset-2 col-mo-8 col-sm-8 col-xxs-8">
								<div class="fh5co-project-item ">
									<div id="answer_container" style="min-width: 310px; height: 0px; max-width: 600px; margin: 0 auto"></div>
								</div>
							</div>
						</div>
					</div>
					<div class="toggler">
						<a role="button" data-toggle="collapse" data-parent="#accordion" href="#myitems" aria-expanded="false" aria-controls="myitems">
									 My Picks
				        </a>
			        </div>
					<div id="myitems" class="collapse in">
						<div class="row">
								<div class="row row-bottom-padded-sm">
								<div class="col-mo-6 col-sm-6 col-xxs-12">
									<div class="fh5co-project-item ">
										<div id="bar_container" style="min-width: 310px; height: 400px; max-width: 600px; margin: 0 auto"></div>
									</div>
								</div>
								<div class="col-mo-6 col-sm-6 col-xxs-12">
									<div class="fh5co-project-item ">
										
										<div id="container" style="min-width: 310px; height: 400px; max-width: 600px; margin: 0 auto"></div>
									</div>
								</div>

								<div class="clearfix visible-sm-block"></div>

								<div class="col-mo-6 col-sm-6 col-xxs-12">
									<div class="fh5co-project-item ">
										
										<div class="fh5co-text">
										<div>Highest withdrawal made</div>
										<div class="timer withdrawal" data-from="0" data-to="100"
				      							data-speed="2000" data-refresh-interval="50"></div>
				      							<div class="cust_data"> 
												    customer=<span class="customer"></span><br>branch=<span class="branch"></span>
												</div>
										</div>
									</div>
								</div>
								<div class="col-mo-6 col-sm-6 col-xxs-12">
									<div class="fh5co-project-item ">
										
										<div class="fh5co-text">
										<div>Highest deposit made</div>
										<div class="timer deposit" data-from="0" data-to="100" 
				      							data-speed="2000" data-refresh-interval="50"></div>
				      							<div class="cust_data"> 
												    customer=<span class="customer"></span><br>branch=<span class="branch"></span>
												</div>
										</div>
									</div>
								</div>
								
							</div>
							

							
						</div>
					</div>	
				</div>
			<div class="clearfix visible-sm-block"></div>
		</div>
	</section>

{% endblock %}
{% block footer %}
    {{ super() }}

	<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>
   <script src="https://code.highcharts.com/highcharts.js"></script>
   <script src="https://code.highcharts.com/modules/exporting.js"></script>
   <script src="{{ url_for('static', filename='js/tabify.js') }}"></script>

   <script src="{{ url_for('static', filename='js/jquery.countTo.js') }}"></script>
   <script src="{{ url_for('static', filename='js/jquery.easing.1.3.js') }}"></script>
   <script>
   Highcharts.setOptions({
	    chart: {
	        style: {
	            fontFamily: "Marvel",
	        }
	    }
	});
   	    let transactions = tabify(JSON.parse({{session['special_query_list'][2]['response'] | tojson}}));
   	    let top5 = tabify(JSON.parse({{session['special_query_list'][0]['response'] | tojson}}));
   	    
   	    let higestWithdrawal = tabify(JSON.parse({{session['special_query_list'][1]['response'] | tojson}})).pop();
   	    let highestDeposit = tabify(JSON.parse({{session['special_query_list'][3]['response'] | tojson}})).pop();

   	    function pageInit() {
   	    	$('.loader_div').hide();
   	    	$('.init_hidden').fadeIn(2000);
		    
   	    	function setvalues(hclass, obj, type) {
	   	    	jQuery(hclass).data('to', obj.amount);
	   	    	jQuery(hclass).next('.cust_data').find('span.customer').text(obj.customer);
	   	    	jQuery(hclass).next('.cust_data').find('span.branch').text(obj.branch);
	   	    }
	   	    setvalues('.timer.deposit',highestDeposit, 'deposit' );
	   	    setvalues('.timer.withdrawal',higestWithdrawal, 'withdrawal' );
   	   		 //build bar graph // How many transaction each branch did?
   			
   			let deposits = transactions[0];
   			let withdrawal = transactions[1];
   			let barCategories = [];
   			let depositsValues = [];
   			let withDrawalValues = [];
   			for (v of Object.values(deposits)) {
				if (v.transaction_by_branch) {
					barCategories.push(v.transaction_by_branch);
					depositsValues.push(v.doc_count);
				}
			}
			for (v of Object.values(withdrawal)) {
				if (v.transaction_by_branch) {
					withDrawalValues.push(v.doc_count);
				}
			}
   			Highcharts.chart('bar_container', {
			    chart: {
			        type: 'column'
			    },
			    title: {
			        text: 'Transaction Volume'
			    },
			    subtitle: {
			        text: 'How many transaction each branch did?'
			    },
			    xAxis: {
			        categories: barCategories,
			        crosshair: true
			    },
			    yAxis: {
			        min: 0,
			        title: {
			            text: 'Amount (USD mn)'
			        }
			    },
			    tooltip: {
			        headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
			        pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
			            '<td style="padding:0"><b>{point.y:.1f} (USD mn)</b></td></tr>',
			        footerFormat: '</table>',
			        shared: true,
			        useHTML: true
			    },
			    plotOptions: {
			        column: {
			            pointPadding: 0,
			            borderWidth: 0,
			            pointWidth: 15,
			        }
			    },
			    series: [{
			        name: 'Withdrawal',
			        data: withDrawalValues

			    }, {
			        name: 'Deposit',
			        data: depositsValues

			    }
			    ]
			});


		    // Build the  pie chart // Top 5 customers by balance
		    let pieData = [];
		    let maxBalance = 0;
		    let maxKey = 0;
		    for (v in top5) {
				let customer = top5[v];
				if (maxBalance < customer.balance) {
					maxBalance = customer.balance;
					maxKey = v;
				}

				pieData.push({
					name : customer.customer, 
					y : customer.balance
				});
			
			}
			//slice out the max customer
			pieData[maxKey] = Object.assign(pieData[maxKey], {sliced:true, selected:true});

		    Highcharts.chart('container', {
		        chart: {
		            plotBackgroundColor: null,
		            plotBorderWidth: null,
		            plotShadow: false,
		            type: 'pie'
		        },
		        title: {
		            text: 'Top 5 customers by balance'
		        },
		        tooltip: {
		            pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
		        },
		        plotOptions: {
		            pie: {
		                allowPointSelect: true,
		                cursor: 'pointer',
		                dataLabels: {
		                    enabled: false
		                },
		                showInLegend: true
		            }
		        },
		        series: [{
		            name: 'Customers',
		            colorByPoint: true,
		            data: pieData
		        }]
		    });

		    //counter for number
		    $('.timer').countTo();
			$('.btn.btn-primary.btn-lg.disabled').removeClass('disabled');
		    // question form submission
		    $('#questions_form').submit(function (e) {
		    	e.preventDefault();
		    	$.ajax({
		    		'url': '/questions', 
		    		'method' : 'POST', 
		    		'dataType': 'json',
		    		'data': $('#questions_form').serialize(),
		    		'success': function  (response) {
		    			//@todo handle various kinds of responses
		    			let chartData = tabify(response);
		    			let chartCategories = [];
		    			let chartValues = [];
		    			// get the y axis plot from the question string. 
		    			let question = $('select[name="question"]').val();
		    			let matches = question.match(/(?:(?:sum of)|(?:max of)) (\w+?) /);
		    			let yLabel = '';
		    			if (matches[1]) {
		    				let yLabel = matches[1];
		    			} else {
		    				alert('Question not supported yet');
		    				return;
		    			}
		    			// get the plotted value 
		    			matches = question.match(/(\w+?) = (.+)/);
		    			let plotLabel = matches[2];
		    			for (v of Object.values(chartData)) {
							if (v.string_field_agg) {
								chartCategories.push(v.string_field_agg);
								chartValues.push(v.numeric);
							}
						}
						$('#answer_container').animate({height:400}, {duration: 1000, easing: 'easeOutCirc'});
						Highcharts.chart('answer_container', {
						    chart: {
						        type: 'column'
						    },
						    title: {
						        text: 'Result'
						    },
						    subtitle: {
						        text: question,
						    },
						    xAxis: {
						        categories: chartCategories,
						        crosshair: true
						    },
						    yAxis: {
						        min: 0,
						        title: {
						            text:  capitalize(yLabel)
						        }
						    },
						    tooltip: {
						        headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
						        pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
						            '<td style="padding:0"><b>{point.y:.1f}</b></td></tr>',
						        footerFormat: '</table>',
						        shared: true,
						        useHTML: true
						    },
						    plotOptions: {
						        column: {
						            pointPadding: 0,
						            borderWidth: 0,
						            pointWidth: 25,
						        }
						    },
						    series: [{
						        name: plotLabel,
						        data: chartValues
						    }
						    ]
						});

		    			$('#questions_form')[0].reset();
		    		}
		    	}) 
		    });
		

   	    }

   		$(document).ready(function () {
   			$('select[name="question"]').select2();
   			setTimeout(function() {
   				pageInit();
   			}, 5000); 

   			$(document).on('click', 'a[data-toggle="collapse"]', function(event) {
			        event.stopPropagation();
			        var $this = $(this);

			        var parent = $this.data('parent');
			        var actives = parent && $(parent).find('.collapse.in');

			        // From bootstrap itself
			        if (actives && actives.length) {
			            hasData = actives.data('collapse');
			            //if (hasData && hasData.transitioning) return;
			            actives.collapse('hide');
			        }

			        var target = $this.attr('data-target') || (href = $this.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, ''); //strip for ie7

			        $(target).collapse('toggle');
			});
		});

		    

	function capitalize(str) {
		return str.toLowerCase().replace(/\b[a-z]/g, function(letter) {
				    return letter.toUpperCase();
				});
	}
   </script>

{% endblock %}